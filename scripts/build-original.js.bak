#!/usr/bin/env node

/**
 * å°ç¨‹åºæ„å»ºè„šæœ¬
 */

const fs = require('fs');
const path = require('path');
const glob = require('glob');

console.log('ğŸš€ å¼€å§‹æ„å»ºèŒ¶å¶å•†åŸå°ç¨‹åº...\n');

function ensureDistDir() {
  const distPath = path.join(process.cwd(), 'dist');
  if (!fs.existsSync(distPath)) {
    fs.mkdirSync(distPath, { recursive: true });
  }
  return distPath;
}

function copyFiles(src, dest, patterns) {
  console.log(`ğŸ“ å¤åˆ¶æ–‡ä»¶: ${src} -> ${dest}`);

  patterns.forEach(pattern => {
    const patternPath = path.join(src, pattern);
    console.log(`ğŸ” æœç´¢æ¨¡å¼: ${patternPath}`);

    try {
      const files = glob.sync(patternPath, {
        dot: false,
        nonull: true
      });

      files.forEach(file => {
        const relativePath = path.relative(src, file);
        const destFile = path.join(dest, relativePath);

        if (fs.existsSync(file) && fs.statSync(file).isFile()) {
          const destDir = path.dirname(destFile);
          if (!fs.existsSync(destDir)) {
            fs.mkdirSync(destDir, { recursive: true });
          }
          fs.copyFileSync(file, destFile);
          console.log(`ğŸ“„ å¤åˆ¶: ${relativePath}`);
        }
      });
    } catch (error) {
      console.warn(`âš ï¸  æ¨¡å¼ ${pattern} åŒ¹é…å¤±è´¥:`, error.message);
    }
  });
}

function generateAppJson() {
  const appJson = {
    pages: [
      "pages/home/index",
      "pages/products/list",
      "pages/products/detail",
      "pages/products/search",
      "pages/cart/index",
      "pages/order/confirm",
      "pages/order/payment",
      "pages/order/result",
      "pages/user/profile",
      "pages/user/orders",
      "pages/user/points",
      "pages/user/address",
      "pages/admin/login",
      "pages/admin/dashboard",
      "pages/admin/products"
    ],
    window: {
      backgroundTextStyle: "light",
      navigationBarBackgroundColor: "#f8f6e4",
      navigationBarTitleText: "èŒ¶å¶å•†åŸ",
      navigationBarTextStyle: "white"
    },
    tabBar: {
      color: "#7A7E8",
      selectedColor: "#1aad19",
      backgroundColor: "#f8f6e4",
      borderStyle: "black",
      list: [
        {
          pagePath: "pages/home/index",
          text: "é¦–é¡µ",
          iconPath: "images/tab/home.png",
          selectedIconPath: "images/tab/home-active.png"
        },
        {
          pagePath: "pages/products/list",
          text: "èŒ¶å¶",
          iconPath: "images/tab/tea.png",
          selectedIconPath: "images/tab/tea-active.png"
        },
        {
          pagePath: "pages/cart/index",
          text: "è´­ç‰©è½¦",
          iconPath: "images/tab/cart.png",
          selectedIconPath: "images/tab/cart-active.png"
        },
        {
          pagePath: "pages/user/profile",
          text: "æˆ‘çš„",
          iconPath: "images/tab/user.png",
          selectedIconPath: "images/tab/user-active.png"
        }
      ]
    },
    permission: {
      "scope.userLocation": {
        desc: "æ‚¨çš„ä½ç½®ä¿¡æ¯å°†ç”¨äºæ”¶è´§åœ°å€"
      }
    },
    networkTimeout: 60000,
    usingComponents: {},
    sitemapLocation: "sitemap.json"
  };

  const distPath = ensureDistDir();
  fs.writeFileSync(
    path.join(distPath, 'app.json'),
    JSON.stringify(appJson, null, 2)
  );
  console.log('âœ… app.json ç”Ÿæˆå®Œæˆ');
}

function main() {
  try {
    // åˆ›å»ºè¾“å‡ºç›®å½•
    const distPath = ensureDistDir();

    // å¤åˆ¶å°ç¨‹åºé¡µé¢æ–‡ä»¶
    console.log('ğŸ“ å¤åˆ¶å°ç¨‹åºæ–‡ä»¶...');
    copyFiles(
      path.join(process.cwd(), 'miniprogram'),
      path.join(distPath, 'miniprogram'),
      [
        'app.js',
        'app.json',
        'sitemap.json',
        'pages/**/*',
        'components/**/*',
        'images/**/*'
      ]
    );

    // å¤åˆ¶äº‘å‡½æ•°æ–‡ä»¶
    console.log('â˜ï¸ å¤åˆ¶äº‘å‡½æ•°æ–‡ä»¶...');
    copyFiles(
      path.join(process.cwd(), 'cloudfunctions'),
      path.join(distPath, 'cloudfunctions'),
      [
        '**/*.js',
        '**/*.json',
        'src/**/*',
        'security-rules-config.json',
        'test-security-rules.js'
      ]
    );

    // ç”Ÿæˆapp.json
    console.log('ğŸ“„ ç”Ÿæˆapp.json...');
    generateAppJson();

    console.log('âœ… æ„å»ºå®Œæˆï¼');
    console.log('ğŸ“‚ è¾“å‡ºç›®å½•:', distPath);

    return { success: true, distPath };

  } catch (error) {
    console.error('âŒ æ„å»ºå¤±è´¥:', error.message);
    return { success: false, error: error.message };
  }
}

if (require.main === module) {
  module.exports = main;
} else {
  main();
}