{
  "rules": {
    "orders": {
      "read": {
        "condition": "auth.openid == resource.data.openid || auth.isSystem == true",
        "description": "用户只能查看自己的订单，系统可查看所有订单"
      },
      "write": {
        "condition": "auth.isSystem == true",
        "description": "仅允许系统通过云函数创建和更新订单"
      },
      "fields": {
        "status": {
          "write": "auth.isSystem == true",
          "description": "订单状态只能由系统更新"
        },
        "payment_info": {
          "read": "auth.isSystem == true",
          "write": "auth.isSystem == true",
          "description": "支付信息仅系统可读写"
        },
        "total_amount": {
          "write": "auth.isSystem == true",
          "description": "订单金额只能由系统设置"
        },
        "admin_openid": {
          "read": "auth.isSystem == true",
          "write": "auth.isSystem == true",
          "description": "操作管理员仅系统可读写"
        }
      }
    },

    "point_records": {
      "read": {
        "condition": "auth.openid == resource.data.openid || auth.isSystem == true",
        "description": "用户只能查看自己的积分记录，系统可查看所有记录"
      },
      "write": {
        "condition": "auth.isSystem == true",
        "description": "仅允许系统通过云函数操作积分记录"
      },
      "fields": {
        "openid": {
          "condition": "resource.data.openid == auth.openid || auth.isSystem == true",
          "description": "用户openid字段只能设置为自己或由系统设置"
        },
        "points_change": {
          "condition": "auth.isSystem == true",
          "description": "积分变更只能由系统操作"
        },
        "transaction_type": {
          "condition": "auth.isSystem == true",
          "description": "交易类型只能由系统定义"
        },
        "operator_openid": {
          "read": "auth.isSystem == true",
          "write": "auth.isSystem == true",
          "description": "操作员openid仅系统可读写"
        }
      }
    },

    "user_points": {
      "read": {
        "condition": "auth.openid == resource.data.openid || auth.isSystem == true",
        "description": "用户只能查看自己的积分余额，系统可查看所有"
      },
      "write": {
        "condition": "auth.isSystem == true",
        "description": "仅允许系统通过云函数更新积分余额"
      },
      "fields": {
        "total_points": {
          "write": "auth.isSystem == true",
          "description": "总积分只能由系统更新"
        }
      }
    },

    "admin_users": {
      "read": {
        "condition": "auth.isSystem == true",
        "description": "仅系统可读取管理员列表"
      },
      "write": {
        "condition": "auth.isSystem == true",
        "description": "仅系统可写入管理员配置"
      },
      "fields": {
        "permissions": {
          "read": "auth.isSystem == true",
          "write": "auth.isSystem == true",
          "description": "权限配置仅系统可读写"
        },
        "is_active": {
          "write": "auth.isSystem == true",
          "description": "激活状态仅系统可修改"
        }
      }
    },

    "products": {
      "read": {
        "condition": "auth.openid != null || auth.isSystem == true",
        "description": "所有登录用户可查看商品信息"
      },
      "write": {
        "condition": "auth.isSystem == true",
        "description": "仅系统可创建和更新商品信息"
      },
      "fields": {
        "inventory_count": {
          "read": "auth.isSystem == true",
          "write": "auth.isSystem == true",
          "description": "库存信息仅系统可读写"
        },
        "cost_price": {
          "read": "auth.isSystem == true",
          "write": "auth.isSystem == true",
          "description": "成本价格仅系统可读写"
        },
        "sold_count": {
          "read": "auth.isSystem == true",
          "write": "auth.isSystem == true",
          "description": "销售数量仅系统可读写"
        },
        "is_active": {
          "write": "auth.isSystem == true",
          "description": "商品状态仅系统可修改"
        },
        "specifications": {
          "read": "auth.openid != null || auth.isSystem == true",
          "write": "auth.isSystem == true",
          "description": "规格信息所有用户可读，仅系统可写"
        },
        "creator_openid": {
          "read": "auth.isSystem == true",
          "write": "auth.isSystem == true",
          "description": "创建者openid仅系统可读写"
        }
      }
    },

    "community_posts": {
      "read": {
        "condition": "(resource.data.status == 'approved' && auth.openid != null) || auth.openid == resource.data.author_openid || auth.isSystem == true",
        "description": "用户可查看已审核的帖子，作者可查看自己的所有帖子，系统可查看所有"
      },
      "write": {
        "condition": "(resource.data.author_openid == auth.openid && resource.data.status == 'pending') || auth.isSystem == true",
        "description": "作者可创建待审核帖子，系统可修改所有状态和内容"
      },
      "fields": {
        "status": {
          "write": "auth.isSystem == true",
          "description": "审核状态只能由系统更新"
        },
        "author_openid": {
          "condition": "resource.data.author_openid == auth.openid || auth.isSystem == true",
          "description": "作者openid只能设置为自己或由系统设置"
        },
        "moderate_time": {
          "read": "auth.isSystem == true",
          "write": "auth.isSystem == true",
          "description": "审核时间仅系统可读写"
        },
        "moderator_openid": {
          "read": "auth.isSystem == true",
          "write": "auth.isSystem == true",
          "description": "审核员openid仅系统可读写"
        },
        "moderate_remark": {
          "read": "auth.isSystem == true",
          "write": "auth.isSystem == true",
          "description": "审核备注仅系统可读写"
        }
      }
    },

    "security_logs": {
      "read": {
        "condition": "auth.isSystem == true",
        "description": "安全日志仅系统可读取"
      },
      "write": {
        "condition": "auth.isSystem == true",
        "description": "安全日志仅系统可写入"
      }
    },

    "categories": {
      "read": {
        "condition": "auth.openid != null || auth.isSystem == true",
        "description": "所有登录用户可查看分类信息"
      },
      "write": {
        "condition": "auth.isSystem == true",
        "description": "仅系统可创建和更新分类"
      },
      "fields": {
        "sort_order": {
          "write": "auth.isSystem == true",
          "description": "排序仅系统可修改"
        },
        "is_active": {
          "write": "auth.isSystem == true",
          "description": "状态仅系统可修改"
        }
      }
    },

    "coupons": {
      "read": {
        "condition": "(auth.openid == resource.data.user_openid && resource.data.user_openid != null) || auth.isSystem == true",
        "description": "用户只能查看自己的优惠券，系统可查看所有"
      },
      "write": {
        "condition": "auth.isSystem == true",
        "description": "仅系统可发放和更新优惠券"
      },
      "fields": {
        "user_openid": {
          "condition": "resource.data.user_openid == auth.openid || auth.isSystem == true",
          "description": "用户openid只能设置为自己或由系统设置"
        },
        "coupon_code": {
          "write": "auth.isSystem == true",
          "description": "优惠券码仅系统可生成"
        },
        "status": {
          "write": "auth.isSystem == true",
          "description": "优惠券状态仅系统可更新"
        },
        "used_time": {
          "write": "auth.isSystem == true",
          "description": "使用时间仅系统可设置"
        }
      }
    },

    "shopping_cart": {
      "read": {
        "condition": "auth.openid == resource.data.openid || auth.isSystem == true",
        "description": "用户只能查看自己的购物车，系统可查看所有"
      },
      "write": {
        "condition": "auth.openid == resource.data.openid || auth.isSystem == true",
        "description": "用户可操作自己的购物车，系统可管理所有"
      },
      "fields": {
        "openid": {
          "condition": "resource.data.openid == auth.openid || auth.isSystem == true",
          "description": "用户openid只能设置为自己或由系统设置"
        },
        "product_id": {
          "write": "auth.openid == resource.data.openid || auth.isSystem == true",
          "description": "商品ID只能所有者或系统设置"
        },
        "price": {
          "write": "auth.isSystem == true",
          "description": "商品价格仅系统可设置（防止价格篡改）"
        }
      }
    },

    "payments": {
      "read": {
        "condition": "auth.openid == resource.data.openid || auth.isSystem == true",
        "description": "用户只能查看自己的支付记录，系统可查看所有"
      },
      "write": {
        "condition": "auth.isSystem == true",
        "description": "仅系统可创建和更新支付记录"
      },
      "fields": {
        "payment_no": {
          "write": "auth.isSystem == true",
          "description": "支付流水号仅系统可生成"
        },
        "transaction_id": {
          "write": "auth.isSystem == true",
          "description": "微信交易号仅系统可设置"
        },
        "payment_status": {
          "write": "auth.isSystem == true",
          "description": "支付状态仅系统可更新"
        },
        "callback_data": {
          "read": "auth.isSystem == true",
          "write": "auth.isSystem == true",
          "description": "回调数据仅系统可读写"
        }
      }
    }
  },

  "best_practices": {
    "description": "安全规则配置最佳实践",
    "principles": [
      "最小权限原则：仅授予必要的最小权限",
      "系统优先原则：关键操作通过auth.isSystem限制为系统级访问",
      "数据隔离原则：用户只能访问自己的数据",
      "审计日志原则：记录所有敏感操作的访问日志"
    ],
    "deployment_checklist": [
      "所有敏感集合的写入权限设置为auth.isSystem == true",
      "用户数据的读取权限基于auth.openid进行隔离",
      "管理员相关集合仅允许系统访问",
      "云函数正确实现了数据验证和权限检查",
      "安全规则测试覆盖所有关键场景",
      "配置了访问日志和监控机制",
      "建立了安全规则变更的审核流程"
    ],
    "testing_scenarios": [
      {
        "name": "用户查看自己订单",
        "collection": "orders",
        "operation": "read",
        "condition": "auth.openid == resource.data.openid",
        "expected_result": "success"
      },
      {
        "name": "用户查看他人订单",
        "collection": "orders",
        "operation": "read",
        "condition": "auth.openid != resource.data.openid",
        "expected_result": "denied"
      },
      {
        "name": "用户直接创建订单",
        "collection": "orders",
        "operation": "write",
        "condition": "auth.isSystem == false",
        "expected_result": "denied"
      },
      {
        "name": "系统创建订单",
        "collection": "orders",
        "operation": "write",
        "condition": "auth.isSystem == true",
        "expected_result": "success"
      },
      {
        "name": "用户查看自己积分",
        "collection": "point_records",
        "operation": "read",
        "condition": "auth.openid == resource.data.openid",
        "expected_result": "success"
      },
      {
        "name": "用户修改积分",
        "collection": "point_records",
        "operation": "write",
        "condition": "auth.isSystem == false",
        "expected_result": "denied"
      },
      {
        "name": "管理员查看商品列表",
        "collection": "admin_users",
        "operation": "read",
        "condition": "auth.isSystem == false",
        "expected_result": "denied"
      },
      {
        "name": "用户查看商品信息",
        "collection": "products",
        "operation": "read",
        "condition": "auth.openid != null",
        "expected_result": "success"
      },
      {
        "name": "用户创建商品",
        "collection": "products",
        "operation": "write",
        "condition": "auth.isSystem == false",
        "expected_result": "denied"
      },
      {
        "name": "用户查看待审核帖子",
        "collection": "community_posts",
        "operation": "read",
        "condition": "resource.data.status == 'pending' && auth.openid != resource.data.author_openid",
        "expected_result": "denied"
      }
    ]
  }
}